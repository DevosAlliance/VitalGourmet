{{extend 'layout.html'}}

<style>
  .filtros-container {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .form-row .form-group {
    margin-bottom: 15px;
  }

  .badge-status {
    font-size: 0.9em;
    padding: 6px 12px;
  }

  .status-pendente {
    background-color: #ffc107;
    color: #000;
  }
  .status-preparacao {
    background-color: #fd7e14;
    color: #fff;
  }
  .status-pronto {
    background-color: #28a745;
    color: #fff;
  }
  .status-entregue {
    background-color: #6c757d;
    color: #fff;
  }

  .small-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    cursor: pointer;
    border-radius: 4px;
  }

  .btn-cancelar {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #fff;
    padding: 4px 8px;
    font-size: 0.8em;
  }

  .btn-cancelar:hover {
    background-color: #c82333;
    border-color: #bd2130;
  }

  .table td,
  .table th {
    vertical-align: middle;
    text-align: center;
  }

  .table td:first-child,
  .table th:first-child {
    text-align: left;
  }

  #loading {
    display: none;
    text-align: center;
    padding: 20px;
    font-size: 1.1em;
    color: #007bff;
  }

  .total-info {
    background-color: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 15px;
    text-align: center;
    font-weight: bold;
    color: #1976d2;
  }
</style>

<h2>üîß Administra√ß√£o de Pedidos</h2>

<!-- Filtros -->
<div class="filtros-container">
  <h5>üîç Filtros</h5>
  <div class="form-row">
    <div class="form-group col-md-3">
      <label for="filtro-nome">Nome do Cliente:</label>
      <input
        type="text"
        class="form-control"
        id="filtro-nome"
        placeholder="Digite o nome..."
      />
    </div>

    <div class="form-group col-md-3">
      <label for="filtro-tipo-usuario">Tipo de Usu√°rio:</label>
      <select class="form-control" id="filtro-tipo-usuario">
        <option value="">Todos os tipos</option>
        {{for tipo in tipos_usuario:}}
        <option value="{{=tipo.id}}">{{=tipo.name}}</option>
        {{pass}}
      </select>
    </div>

    <div class="form-group col-md-3">
      <label for="filtro-setor">Setor:</label>
      <select class="form-control" id="filtro-setor">
        <option value="">Todos os setores</option>
        {{for setor in setores:}}
        <option value="{{=setor.id}}">{{=setor.name}}</option>
        {{pass}}
      </select>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-3">
      <label for="filtro-data-inicio">Data Inicial:</label>
      <input type="date" class="form-control" id="filtro-data-inicio" />
    </div>

    <div class="form-group col-md-3">
      <label for="filtro-data-fim">Data Final:</label>
      <input type="date" class="form-control" id="filtro-data-fim" />
    </div>

    <div class="form-group col-md-6 d-flex align-items-end">
      <button type="button" class="btn btn-secondary" id="limpar-filtros">
        üóëÔ∏è Limpar Filtros
      </button>
      <button type="button" class="btn btn-info ml-2" id="hoje-filtro">
        üìÖ Hoje
      </button>
      <button type="button" class="btn btn-warning ml-2" id="ontem-hoje-filtro">
        üìÖ Ontem-Hoje
      </button>
    </div>
  </div>
</div>

<!-- Informa√ß√µes Totais -->
<div class="total-info" id="total-info" style="display: none">
  <span id="total-pedidos">0</span> pedidos encontrados
</div>

<!-- Loading -->
<div id="loading">
  <i class="fa fa-spinner fa-spin"></i> Carregando pedidos...
</div>

<!-- Tabela de Pedidos -->
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead class="thead-dark">
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>Tipo Usuario</th>
        <th>Setor</th>
        <th>Prato</th>
        <th>Descri√ß√£o</th>
        <th>Tipo Prato</th>
        <th>Foto</th>
        <th>Qtd</th>
        <th>Pre√ßo</th>
        <th>Quarto</th>
        <th>Data/Hora</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabela-pedidos">
      <!-- Dados carregados via AJAX -->
    </tbody>
  </table>
</div>

<!-- Mensagem quando n√£o h√° pedidos -->
<div id="sem-pedidos" style="display: none; text-align: center; padding: 40px">
  <h4>üìù Nenhum pedido encontrado</h4>
  <p>Tente ajustar os filtros ou verificar se h√° pedidos pendentes.</p>
</div>

<!-- Modal para ampliar imagem -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üñºÔ∏è Visualizar Foto do Prato</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" class="img-fluid" src="" alt="Foto do Prato" />
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    // Fun√ß√£o para formatar data para YYYY-MM-DD
    function formatarDataParaInput(data) {
      return data.toISOString().split("T")[0];
    }

    // Fun√ß√£o para definir datas padr√£o (ontem at√© hoje)
    function definirDatasPadrao() {
      const hoje = new Date();
      const ontem = new Date();
      ontem.setDate(hoje.getDate() - 1);

      $("#filtro-data-inicio").val(formatarDataParaInput(ontem));
      $("#filtro-data-fim").val(formatarDataParaInput(hoje));
    }

    // Fun√ß√£o para formatar pre√ßo em Real
    function formatarPreco(valor) {
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
      }).format(valor);
    }

    // Fun√ß√£o para obter classe do status
    function getStatusClass(status) {
      const classes = {
        Pendente: "status-pendente",
        "Em Prepara√ß√£o": "status-preparacao",
        Pronto: "status-pronto",
        Entregue: "status-entregue",
      };
      return classes[status] || "status-pendente";
    }

    // Fun√ß√£o para carregar pedidos via AJAX
    function carregarPedidos() {
      const filtros = {
        nome: $("#filtro-nome").val().trim(),
        tipo_usuario: $("#filtro-tipo-usuario").val(),
        setor: $("#filtro-setor").val(),
        data_inicio: $("#filtro-data-inicio").val(),
        data_fim: $("#filtro-data-fim").val(),
      };

      $("#loading").show();
      $("#tabela-pedidos").empty();
      $("#sem-pedidos").hide();
      $("#total-info").hide();

      $.ajax({
        url: "{{=URL('api_admin_listar_pedidos')}}",
        method: "GET",
        data: filtros,
        success: function (response) {
          $("#loading").hide();

          if (response.status === "success") {
            const pedidos = response.pedidos;
            const tbody = $("#tabela-pedidos");

            if (pedidos.length === 0) {
              $("#sem-pedidos").show();
              return;
            }

            // Mostrar total
            $("#total-pedidos").text(response.total);
            $("#total-info").show();

            // Preencher tabela
            pedidos.forEach(function (pedido) {
              const foto = pedido.foto
                ? `<img src="${pedido.foto}" class="small-image" alt="Foto do Prato" />`
                : '<span class="text-muted">Sem foto</span>';

              const observacoes = pedido.observacoes
                ? `<i class="fa fa-comment" title="${pedido.observacoes}"></i>`
                : "";

              const row = `
                            <tr id="pedido_${pedido.id}">
                                <td>${pedido.id}</td>
                                <td>
                                    <strong>${pedido.solicitante}</strong>
                                    ${observacoes}
                                </td>
                                <td><small>${pedido.tipo_usuario}</small></td>
                                <td><small>${pedido.setor}</small></td>
                                <td>${pedido.prato}</td>
                                <td>${pedido.descricao}</td>
                                <td><small class="text-muted">${
                                  pedido.tipo_prato
                                }</small></td>
                                <td>${foto}</td>
                                <td><strong>${pedido.quantidade}</strong></td>
                                <td><strong>${formatarPreco(
                                  pedido.preco
                                )}</strong></td>
                                <td>${pedido.quarto || "-"}</td>
                                <td><small>${
                                  pedido.data_solicitacao
                                }</small></td>
                                <td>
                                    <span class="badge badge-status ${getStatusClass(
                                      pedido.status
                                    )}">
                                        ${pedido.status}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-cancelar btn-sm cancelar-pedido" data-id="${
                                      pedido.id
                                    }">
                                        ‚ùå Cancelar
                                    </button>
                                </td>
                            </tr>
                        `;
              tbody.append(row);
            });

            // Associar eventos
            associarEventos();
          } else {
            alert("Erro ao carregar pedidos: " + response.message);
          }
        },
        error: function () {
          $("#loading").hide();
          alert("Erro ao conectar com o servidor.");
        },
      });
    }

    // Fun√ß√£o para associar eventos aos bot√µes
    function associarEventos() {
      // Cancelar pedido
      $(".cancelar-pedido")
        .off("click")
        .on("click", function () {
          const pedidoId = $(this).data("id");
          const row = $(`#pedido_${pedidoId}`);

          if (confirm("‚ö†Ô∏è Tem certeza que deseja CANCELAR este pedido?")) {
            const button = $(this);
            button.prop("disabled", true).text("Cancelando...");

            $.post(
              "{{=URL('cozinha','cancelar_pedido')}}",
              { pedido_id: pedidoId },
              function (response) {
                if (response.status === "success") {
                  row.fadeOut(500, function () {
                    $(this).remove();
                    // Atualizar contador
                    const novoTotal = parseInt($("#total-pedidos").text()) - 1;
                    $("#total-pedidos").text(novoTotal);

                    if (novoTotal === 0) {
                      $("#sem-pedidos").show();
                      $("#total-info").hide();
                    }
                  });
                } else {
                  alert("Erro ao cancelar pedido: " + response.message);
                  button.prop("disabled", false).text("‚ùå Cancelar");
                }
              }
            ).fail(function () {
              alert("Erro ao conectar com o servidor.");
              button.prop("disabled", false).text("‚ùå Cancelar");
            });
          }
        });

      // Ampliar imagem
      $(".small-image")
        .off("click")
        .on("click", function () {
          const imgSrc = $(this).attr("src");
          $("#modalImage").attr("src", imgSrc);
          $("#imageModal").modal("show");
        });
    }

    // Eventos dos filtros
    $("#limpar-filtros").on("click", function () {
      $("#filtro-nome").val("");
      $("#filtro-tipo-usuario").val("");
      $("#filtro-setor").val("");
      definirDatasPadrao(); // Volta para ontem-hoje
      carregarPedidos();
    });

    // Bot√£o "Hoje"
    $("#hoje-filtro").on("click", function () {
      const hoje = new Date();
      $("#filtro-data-inicio").val(formatarDataParaInput(hoje));
      $("#filtro-data-fim").val(formatarDataParaInput(hoje));
      carregarPedidos();
    });

    // Bot√£o "Ontem-Hoje"
    $("#ontem-hoje-filtro").on("click", function () {
      definirDatasPadrao();
      carregarPedidos();
    });

    // Filtro autom√°tico ao digitar (com delay)
    let timeoutId;
    $("#filtro-nome").on("input", function () {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(carregarPedidos, 500);
    });

    // Filtro autom√°tico ao mudar select ou datas
    $(
      "#filtro-tipo-usuario, #filtro-setor, #filtro-data-inicio, #filtro-data-fim"
    ).on("change", carregarPedidos);

    // Definir datas padr√£o e carregar pedidos inicial
    definirDatasPadrao();
    carregarPedidos();
  });
</script>
