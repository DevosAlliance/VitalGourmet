{{extend 'layout.html'}}

<style>
  .pagination .btn {
    margin-right: 5px;
    color: #ffffff;
  }

  .pagination .btn.active {
    background-color: #007bff !important;
    color: #fff;
    border-color: #007bff !important;
  }

  .pagination .btn.active:focus {
    outline: none;
    box-shadow: none;
  }
  .form-inline .form-group {
    display: flex;
    flex: 0 0 auto;
    flex-flow: row wrap;
    margin-bottom: 0;
    flex-direction: column;
  }

  /* Estilos para o resumo por tipo */
  .resumo-container {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .resumo-tipo {
    display: inline-block;
    background-color: #ffffff;
    border: 1px solid #007bff;
    border-radius: 8px;
    padding: 10px 15px;
    margin: 5px;
    min-width: 180px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .resumo-tipo h6 {
    color: #007bff;
    margin-bottom: 8px;
    font-weight: bold;
  }

  .resumo-tipo .valor {
    font-size: 0.9em;
    margin: 2px 0;
  }

  .totais-gerais {
    background-color: #e3f2fd;
    border: 2px solid #2196f3;
    font-weight: bold;
  }

  .totais-gerais h6 {
    color: #1976d2;
  }
  tr.pedido-row {
    cursor: pointer;
  }

</style>

<h2>Pedidos de Refei칞칚o</h2>

<!-- Formul치rio de Filtros -->
<form
  method="GET"
  action="{{=URL('default', 'admin_pedidos')}}"
  class="form-inline mb-3"
>
  <!-- Nome do Usu치rio -->
  <div class="form-group mr-2">
    <label for="nome">Nome do Usu치rio</label>
    <input
      type="text"
      name="nome"
      id="nome"
      class="form-control ml-2"
      placeholder="Nome"
      value="{{=request.vars.nome or ''}}"
    />
  </div>

  <!-- Nome do Prato (Novo) -->
  <div class="form-group mr-2">
    <label for="nome_prato">Nome do Prato</label>
    <input
      type="text"
      name="nome_prato"
      id="nome_prato"
      class="form-control ml-2"
      placeholder="Nome do Prato"
      value="{{=request.vars.nome_prato or ''}}"
    />
  </div>

  <!-- Tipo de Usu치rio -->
  <div class="form-group mr-2">
    <label for="tipo_usuario">Tipo de Usu치rio</label>
    <select name="tipo_usuario" id="tipo_usuario" class="form-control ml-2">
      <option value="">Todos</option>
      {{for tipo in tipos_usuario:}}
      <option value="{{=tipo}}" {{='selected' if request.vars.tipo_usuario == tipo else ''}}>
        {{=tipo}}
      </option>
      {{pass}}
    </select>
  </div>

  <!-- Setor -->
  <div class="form-group mr-2">
    <label for="setor">Setor</label>
    <select name="setor" id="setor" class="form-control ml-2">
      <option value="">Todos</option>
      {{for setor in setores:}}
      <option value="{{=setor.id}}" {{='selected' if request.vars.setor == str(setor.id) else ''}}>
        {{=setor.name}}
      </option>
      {{pass}}
    </select>
  </div>

  <!-- Data In칤cio -->
  <div class="form-group mr-2">
    <label for="data_inicio">Data In칤cio</label>
    <input
      type="date"
      name="data_inicio"
      id="data_inicio"
      class="form-control ml-2"
      value="{{=request.vars.data_inicio or ''}}"
    />
  </div>

  <!-- Data Fim -->
  <div class="form-group mr-2">
    <label for="data_fim">Data Fim</label>
    <input
      type="date"
      name="data_fim"
      id="data_fim"
      class="form-control ml-2"
      value="{{=request.vars.data_fim or ''}}"
    />
  </div>

  <!-- Tipo de Refei칞칚o -->
  <div class="form-group mr-2">
    <label for="tipo_refeicao">Tipo de Refei칞칚o</label>
    <select name="tipo_refeicao" id="tipo_refeicao" class="form-control ml-2">
      <option value="">Todos</option>
      <option value="especial" {{='selected' if request.vars.tipo_refeicao == "especial" else ''}}>
        A la carte
      </option>
      <option value="comum" {{='selected' if request.vars.tipo_refeicao == "comum" else ''}}>
        Comum
      </option>
    </select>
  </div>

  <button type="submit" class="btn btn-primary" style="position: relative; bottom: -10px;">Filtrar</button>
</form>

<!-- NOVO: Resumo por Tipo de Refei칞칚o -->
<div class="resumo-container">
  <h4 style="margin-bottom: 15px; color: #495057;">游늵 Resumo por Tipo de Refei칞칚o</h4>
  
  <!-- Totais por tipo espec칤fico -->
  {{for tipo, dados in resumo_por_tipo.items():}}
  <div class="resumo-tipo">
    <h6>{{=tipo}}</h6>
    <div class="valor">Pedidos: {{=dados['pedidos']}}</div>
    <div class="valor">unidades: {{=dados['pratos']}}</div>
    <div class="valor receita" data-valor="{{=dados['receita']}}">Receita: </div>
  </div>
  {{pass}}

  <!-- Totais gerais -->
  <div class="resumo-tipo totais-gerais">
    <h6>游댝 TOTAL GERAL</h6>
    <div class="valor">Pedidos: {{=total_pedidos}}</div>
    <div class="valor">unidades: {{=total_pratos}}</div>
    <div class="valor receita" data-valor="{{=preco_total}}">Receita: </div>
  </div>
</div>

<!-- Tabela de Pedidos -->
{{if not pedidos:}}
<p>Nenhuma solicita칞칚o encontrada.</p>
{{else:}}
<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Nome do Usu치rio</th>
        <th>Setor</th>
        <th>Nome do Prato</th>
        <th>Quantidade</th>
        <th>Data</th>
        <th>Pre칞o</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {{for pedido in pedidos:}}
      <tr
        class="pedido-row"
        data-prato="{{=pedido.cardapio.nome}}"
        data-quantidade="{{=pedido.solicitacao_refeicao.quantidade_solicitada}}"
        data-preco="{{=pedido.solicitacao_refeicao.preco}}"
        data-descricao="{{=pedido.solicitacao_refeicao.descricao or ''}}"
        data-tipo-refeicao="{{=pedido.cardapio.tipo}}"
      >
        <td>{{=pedido.auth_user.first_name}}</td>
        <td>{{=pedido.auth_user.setor_id.name if pedido.auth_user.setor_id else ''}}</td>
        <td>{{=pedido.cardapio.nome}}</td>
        <td>{{=pedido.solicitacao_refeicao.quantidade_solicitada}}</td>
        <td>{{=pedido.solicitacao_refeicao.data_solicitacao.strftime('%d/%m/%Y') if pedido.solicitacao_refeicao.data_solicitacao else ''}}</td>
        <td data-valor="{{=pedido.solicitacao_refeicao.preco}}"></td>
        <td>{{=pedido.solicitacao_refeicao.status}}</td>
      </tr>
      {{pass}}
    </tbody>
  </table>
</div>

<div class="pagination">
  {{if pagina > 1:}}
    <a href="{{=URL(vars=dict(request.vars, pagina=pagina-1))}}" class="btn btn-secondary">Anterior</a>
  {{pass}}

  <!-- Sempre exibe 1, 2, 3 e 4 -->
  {{for i in range(1, min(5, total_paginas + 1)):}}
    <a href="{{=URL(vars=dict(request.vars, pagina=i))}}" class="btn btn-secondary {{='active' if i == pagina else ''}}">
      {{=i}}
    </a>
  {{pass}}

  <!-- Adiciona retic칡ncias se houver mais p치ginas -->
  {{if total_paginas > 4 and pagina < total_paginas:}}
    <span class="btn btn-secondary disabled">...</span>
    <a href="{{=URL(vars=dict(request.vars, pagina=pagina+1))}}" class="btn btn-secondary">Pr칩xima</a>
    <a href="{{=URL(vars=dict(request.vars, pagina=total_paginas))}}" class="btn btn-secondary">칔ltima</a>
  {{pass}}
</div>

{{pass}}

<!-- Modal para detalhes do pedido -->
<div
  class="modal fade"
  id="pedidoModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="pedidoModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pedidoModalLabel">Detalhes do Pedido</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p><strong>Nome do Prato:</strong> <span id="modalPratoNome"></span></p>
        <p>
          <strong>Quantidade Solicitada:</strong>
          <span id="modalQuantidade"></span>
        </p>
        <p><strong>Pre칞o:</strong> R$ <span id="modalPreco"></span></p>
        <p><strong>Descri칞칚o:</strong> <span id="modalDescricao"></span></p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Fun칞칚o para formatar valores em BRL
    function formatarBRL(valor) {
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL"
      }).format(valor);
    }

    // Seleciona todos os elementos com o atributo data-valor
    const elementosComValor = document.querySelectorAll("[data-valor]");
    
    // Itera sobre os elementos e formata os valores
    elementosComValor.forEach(function(elemento) {
      const valorBruto = parseFloat(elemento.getAttribute("data-valor"));
      
      // Para elementos com classe 'receita', adiciona o valor formatado ao texto existente
      if (elemento.classList.contains('receita')) {
        elemento.textContent += formatarBRL(valorBruto);
      } else {
        elemento.textContent = formatarBRL(valorBruto);
      }
    });
  });
</script>

<script>
  $(document).ready(function () {
    // Exibir modal com detalhes do pedido ao clicar na linha
    $(".pedido-row").click(function () {
      var prato = $(this).data("prato");
      var quantidade = $(this).data("quantidade");
      var preco = parseFloat($(this).data("preco"));
      var descricao = $(this).data("descricao") || "Nenhuma descri칞칚o fornecida.";

      $("#modalPratoNome").text(prato);
      $("#modalQuantidade").text(quantidade);
      $("#modalPreco").text(preco.toFixed(2));
      $("#modalDescricao").text(descricao);
      $("#pedidoModal").modal("show");
    });

    // Filtro pelo tipo de refei칞칚o
    $("#tipo_refeicao").change(function() {
      var selectedTipo = $(this).val();

      $(".pedido-row").each(function() {
        var tipoRefeicao = $(this).data("tipo-refeicao");

        if (selectedTipo === "" || tipoRefeicao === selectedTipo) {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
    });
  });
</script>