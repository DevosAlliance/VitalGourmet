{{extend 'layout.html'}}

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
  .pagination .btn {
    margin-right: 5px;
    color: #ffffff;
  }

  .pagination .btn.active {
    background-color: #007bff !important;
    color: #fff;
    border-color: #007bff !important;
  }

  .pagination .btn.active:focus {
    outline: none;
    box-shadow: none;
  }
  
  .form-inline .form-group {
    display: flex;
    flex: 0 0 auto;
    flex-flow: row wrap;
    margin-bottom: 0;
    flex-direction: column;
  }

  /* Estilos para o resumo por tipo */
  .resumo-container {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .resumo-tipo {
    display: inline-block;
    background-color: #ffffff;
    border: 1px solid #007bff;
    border-radius: 8px;
    padding: 10px 15px;
    margin: 5px;
    min-width: 180px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .resumo-tipo:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-color: #0056b3;
  }

  .resumo-tipo:active {
    transform: translateY(0);
    transition: transform 0.1s ease;
  }

  .resumo-tipo h6 {
    color: #007bff;
    margin-bottom: 8px;
    font-weight: bold;
  }

  .resumo-tipo .valor {
    font-size: 0.9em;
    margin: 2px 0;
  }

  .resumo-tipo .analytics-hint {
    font-size: 0.8em;
    color: #6c757d;
    margin-top: 5px;
    font-style: italic;
  }

  .totais-gerais {
    background-color: #e3f2fd;
    border: 2px solid #2196f3;
    font-weight: bold;
  }

  .totais-gerais h6 {
    color: #1976d2;
  }

  tr.pedido-row {
    cursor: pointer;
  }

  /* Estilos para a modal de analytics */
  .analytics-modal {
    max-width: 98%;
    width: 1400px;
  }

  .analytics-header {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    padding: 20px;
    border-radius: 8px 8px 0 0;
    margin: -1rem -1rem 1rem -1rem;
  }

  .analytics-section {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .analytics-section h5 {
    color: #495057;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }

  .metric-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
  }

  .metric-title {
    font-weight: bold;
    color: #495057;
    margin-bottom: 8px;
  }

  .metric-value {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .metric-number {
    font-size: 1.1em;
    font-weight: bold;
    color: #007bff;
  }

  .metric-money {
    font-size: 1.1em;
    font-weight: bold;
    color: #28a745;
  }

  .progress-container {
    margin-top: 8px;
  }

  .progress {
    height: 8px;
    border-radius: 4px;
  }

  /* Estilos para gráficos */
  .charts-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }

  .chart-wrapper {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
  }

  .chart-title {
    font-weight: bold;
    color: #495057;
    margin-bottom: 15px;
    text-align: center;
    font-size: 1.1em;
  }

  .chart-canvas {
    position: relative;
    height: 300px;
    width: 100%;
  }

  .full-width-chart {
    grid-column: 1 / -1;
  }

  .skeleton-analytics {
    background-color: #e0e0e0;
    border-radius: 4px;
    height: 20px;
    margin-bottom: 10px;
    position: relative;
    overflow: hidden;
  }

  .skeleton-analytics::after {
    content: "";
    display: block;
    position: absolute;
    left: -100%;
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% { left: -100%; }
    50% { left: 100%; }
    100% { left: 100%; }
  }

  .no-data-message {
    text-align: center;
    padding: 40px;
    color: #6c757d;
  }

  .analytics-summary {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 10px;
  }

  .summary-item {
    text-align: center;
  }

  .summary-value {
    font-size: 1.5em;
    font-weight: bold;
    display: block;
  }

  .summary-label {
    font-size: 0.9em;
    opacity: 0.9;
  }

  /* Estilos específicos para impressão */
  @media print {
    .analytics-modal {
      max-width: none;
      width: 100%;
      margin: 0;
    }
    
    .analytics-header {
      background: #007bff !important;
      color: white !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    .charts-container {
      grid-template-columns: 1fr;
      gap: 30px;
      page-break-inside: avoid;
    }
    
    .chart-wrapper {
      page-break-inside: avoid;
      margin-bottom: 30px;
    }
    
    .analytics-section {
      page-break-inside: avoid;
      margin-bottom: 30px;
    }
    
    .summary-grid {
      grid-template-columns: repeat(4, 1fr);
    }
    
    /* Garantir que cores sejam impressas */
    * {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }

  /* Responsividade */
  @media (max-width: 1200px) {
    .charts-container {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .analytics-modal {
      max-width: 98%;
      width: 100%;
      margin: 10px;
    }
    
    .analytics-section {
      padding: 15px;
    }
    
    .metric-value {
      flex-direction: column;
      align-items: flex-start;
    }

    .analytics-header .d-flex {
      flex-direction: column;
      gap: 15px;
    }

    .summary-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .resumo-container {
      padding: 10px;
    }

    .resumo-tipo {
      min-width: 150px;
      padding: 8px 12px;
    }

    .form-inline {
      flex-direction: column;
    }

    .form-inline .form-group {
      width: 100%;
      margin-bottom: 10px;
    }

    .charts-container {
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .chart-canvas {
      height: 250px;
    }
  }

  @media (max-width: 576px) {
    .summary-grid {
      grid-template-columns: 1fr;
    }

    .resumo-tipo {
      display: block;
      margin: 5px 0;
    }

    .chart-canvas {
      height: 200px;
    }
  }
</style>

<h2>Pedidos de Refeição</h2>

<!-- Formulário de Filtros -->
<form
  method="GET"
  action="{{=URL('default', 'admin_pedidos')}}"
  class="form-inline mb-3"
>
  <!-- Nome do Usuário -->
  <div class="form-group mr-2">
    <label for="nome">Nome do Usuário</label>
    <input
      type="text"
      name="nome"
      id="nome"
      class="form-control ml-2"
      placeholder="Nome"
      value="{{=request.vars.nome or ''}}"
    />
  </div>

  <!-- Nome do Prato -->
  <div class="form-group mr-2">
    <label for="nome_prato">Nome do Prato</label>
    <input
      type="text"
      name="nome_prato"
      id="nome_prato"
      class="form-control ml-2"
      placeholder="Nome do Prato"
      value="{{=request.vars.nome_prato or ''}}"
    />
  </div>

  <!-- Tipo de Usuário -->
  <div class="form-group mr-2">
    <label for="tipo_usuario">Tipo de Usuário</label>
    <select name="tipo_usuario" id="tipo_usuario" class="form-control ml-2">
      <option value="">Todos</option>
      {{for tipo in tipos_usuario:}}
      <option value="{{=tipo}}" {{='selected' if request.vars.tipo_usuario == tipo else ''}}>
        {{=tipo}}
      </option>
      {{pass}}
    </select>
  </div>

  <!-- Setor -->
  <div class="form-group mr-2">
    <label for="setor">Setor</label>
    <select name="setor" id="setor" class="form-control ml-2">
      <option value="">Todos</option>
      {{for setor in setores:}}
      <option value="{{=setor.id}}" {{='selected' if request.vars.setor == str(setor.id) else ''}}>
        {{=setor.name}}
      </option>
      {{pass}}
    </select>
  </div>

  <!-- Data Início -->
  <div class="form-group mr-2">
    <label for="data_inicio">Data Início</label>
    <input
      type="date"
      name="data_inicio"
      id="data_inicio"
      class="form-control ml-2"
      value="{{=request.vars.data_inicio or ''}}"
    />
  </div>

  <!-- Data Fim -->
  <div class="form-group mr-2">
    <label for="data_fim">Data Fim</label>
    <input
      type="date"
      name="data_fim"
      id="data_fim"
      class="form-control ml-2"
      value="{{=request.vars.data_fim or ''}}"
    />
  </div>

  <!-- Tipo de Refeição -->
  <div class="form-group mr-2">
    <label for="tipo_refeicao">Tipo de Refeição</label>
    <select name="tipo_refeicao" id="tipo_refeicao" class="form-control ml-2">
      <option value="">Todos</option>
      <option value="especial" {{='selected' if request.vars.tipo_refeicao == "especial" else ''}}>
        A la carte
      </option>
      <option value="comum" {{='selected' if request.vars.tipo_refeicao == "comum" else ''}}>
        Comum
      </option>
    </select>
  </div>

  <button type="submit" class="btn btn-primary" style="position: relative; bottom: -10px;">Filtrar</button>
</form>

<!-- Resumo por Tipo de Refeição -->
<div class="resumo-container">
  <h4 style="margin-bottom: 15px; color: #495057;">📊 Resumo por Tipo de Refeição</h4>
  <p class="text-muted">Clique em qualquer tipo de refeição para ver analytics detalhados com gráficos</p>
  
  <!-- Totais por tipo específico -->
  {{for tipo, dados in resumo_por_tipo.items():}}
  <div class="resumo-tipo" onclick="abrirAnalytics('{{=tipo}}')" data-tipo="{{=tipo}}" 
       title="Clique para ver analytics detalhados de {{=tipo}}" data-bs-toggle="tooltip">
    <h6>{{=tipo}}</h6>
    <div class="valor">Pedidos: {{=dados['pedidos']}}</div>
    <div class="valor">Unidades: {{=dados['pratos']}}</div>
    <div class="valor receita" data-valor="{{=dados['receita']}}">Receita: </div>
    <div class="analytics-hint">
      <i class="fas fa-chart-bar"></i> Clique para gráficos
    </div>
  </div>
  {{pass}}

  <!-- Totais gerais - CLICÁVEL -->
  <div class="resumo-tipo totais-gerais" onclick="abrirAnalytics('TOTAL_GERAL')" data-tipo="TOTAL_GERAL" 
       title="Clique para ver analytics gerais completos com gráficos" data-bs-toggle="tooltip">
    <h6>🔢 TOTAL GERAL</h6>
    <div class="valor">Pedidos: {{=total_pedidos}}</div>
    <div class="valor">Unidades: {{=total_pratos}}</div>
    <div class="valor receita" data-valor="{{=preco_total}}">Receita: </div>
    <div class="analytics-hint">
      <i class="fas fa-chart-bar"></i> Clique para gráficos
    </div>
  </div>
</div>

<!-- Tabela de Pedidos -->
{{if not pedidos:}}
<p>Nenhuma solicitação encontrada.</p>
{{else:}}
<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Nome do Usuário</th>
        <th>Setor</th>
        <th>Nome do Prato</th>
        <th>Quantidade</th>
        <th>Data</th>
        <th>Preço</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {{for pedido in pedidos:}}
      <tr
        class="pedido-row"
        data-prato="{{=pedido.cardapio.nome}}"
        data-quantidade="{{=pedido.solicitacao_refeicao.quantidade_solicitada}}"
        data-preco="{{=pedido.solicitacao_refeicao.preco}}"
        data-descricao="{{=pedido.solicitacao_refeicao.descricao or ''}}"
        data-tipo-refeicao="{{=pedido.cardapio.tipo}}"
      >
        <td>{{=pedido.auth_user.first_name}}</td>
        <td>{{=pedido.auth_user.setor_id.name if pedido.auth_user.setor_id else 'Sem setor'}}</td>
        <td>{{=pedido.cardapio.nome}}</td>
        <td>{{=pedido.solicitacao_refeicao.quantidade_solicitada}}</td>
        <td>{{=pedido.solicitacao_refeicao.data_solicitacao.strftime('%d/%m/%Y') if pedido.solicitacao_refeicao.data_solicitacao else ''}}</td>
        <td data-valor="{{=pedido.solicitacao_refeicao.preco}}"></td>
        <td>{{=pedido.solicitacao_refeicao.status}}</td>
      </tr>
      {{pass}}
    </tbody>
  </table>
</div>

<div class="pagination">
  {{if pagina > 1:}}
    <a href="{{=URL(vars=dict(request.vars, pagina=pagina-1))}}" class="btn btn-secondary">Anterior</a>
  {{pass}}

  {{for i in range(1, min(5, total_paginas + 1)):}}
    <a href="{{=URL(vars=dict(request.vars, pagina=i))}}" class="btn btn-secondary {{='active' if i == pagina else ''}}">
      {{=i}}
    </a>
  {{pass}}

  {{if total_paginas > 4 and pagina < total_paginas:}}
    <span class="btn btn-secondary disabled">...</span>
    <a href="{{=URL(vars=dict(request.vars, pagina=pagina+1))}}" class="btn btn-secondary">Próxima</a>
    <a href="{{=URL(vars=dict(request.vars, pagina=total_paginas))}}" class="btn btn-secondary">Última</a>
  {{pass}}
</div>

{{pass}}

<!-- Modal para detalhes do pedido -->
<div class="modal fade" id="pedidoModal" tabindex="-1" role="dialog" aria-labelledby="pedidoModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pedidoModalLabel">Detalhes do Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Nome do Prato:</strong> <span id="modalPratoNome"></span></p>
        <p><strong>Quantidade Solicitada:</strong> <span id="modalQuantidade"></span></p>
        <p><strong>Preço:</strong> R$ <span id="modalPreco"></span></p>
        <p><strong>Descrição:</strong> <span id="modalDescricao"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Analytics Detalhados com Gráficos -->
<div class="modal fade" id="analyticsModal" tabindex="-1" aria-labelledby="analyticsModalLabel" aria-hidden="true">
  <div class="modal-dialog analytics-modal">
    <div class="modal-content">
      <div class="modal-body">
        <div class="analytics-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0">
                <i class="fas fa-chart-pie"></i>
                Analytics Detalhados: <span id="analyticsTypeTitle"></span>
              </h4>
              <p class="mb-0 mt-2" id="analyticsSubtitle">Análise completa com gráficos visuais</p>
            </div>
            <div class="d-flex gap-2">
              <!-- <button type="button" class="btn btn-light" onclick="exportarAnalytics()" title="Exportar para CSV">
                <i class="fas fa-download"></i>
              </button> -->
              <button type="button" class="btn btn-light" onclick="imprimirAnalytics()" title="Imprimir relatório com gráficos">
                <i class="fas fa-print"></i>
              </button>
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div id="analyticsLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <p class="mt-3">Processando dados analíticos e gerando gráficos...</p>
        </div>

        <!-- Analytics Content -->
        <div id="analyticsContent" class="d-none">
          <!-- Resumo Geral -->
          <div class="analytics-summary">
            <h5 class="mb-3">
              <i class="fas fa-clipboard-list"></i>
              Resumo Geral
            </h5>
            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-value" id="summaryTotalPedidos">0</span>
                <span class="summary-label">Total de Pedidos</span>
              </div>
              <div class="summary-item">
                <span class="summary-value" id="summaryTotalUnidades">0</span>
                <span class="summary-label">Total de Unidades</span>
              </div>
              <div class="summary-item">
                <span class="summary-value" id="summaryTotalReceita">R$ 0,00</span>
                <span class="summary-label">Receita Total</span>
              </div>
              <div class="summary-item">
                <span class="summary-value" id="summaryMediaPedido">R$ 0,00</span>
                <span class="summary-label">Média por Pedido</span>
              </div>
            </div>
          </div>

          <!-- Gráficos Visuais -->
          <div class="analytics-section">
            <h5>
              <i class="fas fa-chart-bar"></i>
              Análise Visual
            </h5>
            <div class="charts-container" id="chartsContainer">
              <!-- Gráficos serão inseridos dinamicamente -->
            </div>
          </div>

          <!-- Analytics por Tipo de Refeição (só aparece no TOTAL_GERAL) -->
          <div class="analytics-section" id="sectionByTipoRefeicao" style="display: none;">
            <h5>
              <i class="fas fa-utensils"></i>
              Consumo por Tipo de Refeição
            </h5>
            <div id="analyticsByTipoRefeicao"></div>
          </div>

          <!-- Analytics por Tipo de Usuário -->
          <div class="analytics-section">
            <h5>
              <i class="fas fa-users"></i>
              Consumo por Tipo de Usuário
            </h5>
            <div id="analyticsByUserType"></div>
          </div>

          <!-- Analytics por Setor -->
          <div class="analytics-section">
            <h5>
              <i class="fas fa-building"></i>
              Consumo por Setor
            </h5>
            <div id="analyticsBySetor"></div>
          </div>
        </div>

        <!-- Error State -->
        <div id="analyticsError" class="d-none">
          <div class="no-data-message">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h5>Erro ao carregar dados</h5>
            <p>Não foi possível carregar os dados analíticos. Tente novamente.</p>
            <button class="btn btn-primary" onclick="recarregarAnalytics()">
              <i class="fas fa-refresh"></i> Tentar Novamente
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalhes por Usuário Individual -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
        <h5 class="modal-title" id="userDetailsModalLabel">
          <i class="fas fa-users"></i> Detalhes por Usuário - <span id="userTypeTitle"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Loading State -->
        <div id="userDetailsLoading" class="text-center py-4">
          <div class="spinner-border text-success" role="status"></div>
          <p class="mt-3">Carregando detalhes dos usuários...</p>
        </div>

        <!-- Content -->
        <div id="userDetailsContent" class="d-none">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Total de usuários:</strong> <span id="totalUsers">0</span> |
            <strong>Receita total:</strong> <span id="totalRevenue">R$ 0,00</span>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-success">
                <tr>
                  <th>Nome do Usuário</th>
                  <th>Setor</th>
                  <th>Total de Pedidos</th>
                  <th>Total Gasto</th>
                  <th>Média por Pedido</th>
                </tr>
              </thead>
              <tbody id="userDetailsTable">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Error State -->
        <div id="userDetailsError" class="d-none">
          <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h5>Erro ao carregar detalhes</h5>
            <p>Não foi possível carregar os detalhes dos usuários.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-success" onclick="exportarDetalhesUsuarios()">
          <i class="fas fa-download"></i> Exportar CSV
        </button> -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalhes por Setor -->
<div class="modal fade" id="setorDetailsModal" tabindex="-1" aria-labelledby="setorDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
        <h5 class="modal-title" id="setorDetailsModalLabel">
          <i class="fas fa-building"></i> Detalhes por Setor - <span id="setorTitle"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Loading State -->
        <div id="setorDetailsLoading" class="text-center py-4">
          <div class="spinner-border text-info" role="status"></div>
          <p class="mt-3">Carregando detalhes do setor...</p>
        </div>

        <!-- Content -->
        <div id="setorDetailsContent" class="d-none">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Total de usuários:</strong> <span id="totalUsersSetor">0</span> |
            <strong>Receita total:</strong> <span id="totalRevenueSetor">R$ 0,00</span>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-info">
                <tr>
                  <th>Nome do Usuário</th>
                  <th>Tipo de Usuário</th>
                  <th>Total de Pedidos</th>
                  <th>Total Gasto</th>
                  <th>Média por Pedido</th>
                </tr>
              </thead>
              <tbody id="setorDetailsTable">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Error State -->
        <div id="setorDetailsError" class="d-none">
          <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h5>Erro ao carregar detalhes</h5>
            <p>Não foi possível carregar os detalhes do setor.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-info" onclick="exportarDetalhesSetor()">
          <i class="fas fa-download"></i> Exportar CSV
        </button> -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalhes por Tipo de Refeição -->
<div class="modal fade" id="tipoRefeicaoDetailsModal" tabindex="-1" aria-labelledby="tipoRefeicaoDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%); color: white;">
        <h5 class="modal-title" id="tipoRefeicaoDetailsModalLabel">
          <i class="fas fa-utensils"></i> Detalhes por Tipo de Refeição - <span id="tipoRefeicaoTitle"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Loading State -->
        <div id="tipoRefeicaoDetailsLoading" class="text-center py-4">
          <div class="spinner-border text-warning" role="status"></div>
          <p class="mt-3">Carregando detalhes do tipo de refeição...</p>
        </div>

        <!-- Content -->
        <div id="tipoRefeicaoDetailsContent" class="d-none">
          <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i>
            <strong>Total de usuários:</strong> <span id="totalUsersTipoRefeicao">0</span> |
            <strong>Receita total:</strong> <span id="totalRevenueTipoRefeicao">R$ 0,00</span>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-warning">
                <tr>
                  <th>Nome do Usuário</th>
                  <th>Tipo de Usuário</th>
                  <th>Setor</th>
                  <th>Total de Pedidos</th>
                  <th>Total Gasto</th>
                  <th>Média por Pedido</th>
                </tr>
              </thead>
              <tbody id="tipoRefeicaoDetailsTable">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Error State -->
        <div id="tipoRefeicaoDetailsError" class="d-none">
          <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h5>Erro ao carregar detalhes</h5>
            <p>Não foi possível carregar os detalhes do tipo de refeição.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-warning" onclick="exportarDetalhesTipoRefeicao()">
          <i class="fas fa-download"></i> Exportar CSV
        </button> -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Variáveis globais
  let currentAnalyticsType = null;
  let analyticsCache = {};
  let analyticsCharts = {}; // Para armazenar instâncias dos gráficos

   // Event listeners para as modals de detalhes
  const userDetailsModal = document.getElementById('userDetailsModal');
  const setorDetailsModal = document.getElementById('setorDetailsModal');
  const analyticsModal = document.getElementById('analyticsModal');
  
  // Função para garantir que o body mantenha as classes corretas
  function fixModalScroll() {
    // Verificar se ainda há modals abertas
    const openModals = document.querySelectorAll('.modal.show');
    
    if (openModals.length > 0) {
      // Se ainda há modals abertas, garantir que o body tenha as classes necessárias
      document.body.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
      document.body.style.paddingRight = '17px'; // Compensar a scrollbar
    } else {
      // Se não há modals abertas, limpar as classes
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    }
  }
  
  // Event listeners para modal de detalhes de usuários
  if (userDetailsModal) {
    userDetailsModal.addEventListener('hidden.bs.modal', function() {
      setTimeout(fixModalScroll, 50); // Pequeno delay para garantir que o Bootstrap terminou
    });
    
    userDetailsModal.addEventListener('shown.bs.modal', function() {
      fixModalScroll();
    });
  }
  
  // Event listeners para modal de detalhes de setor
  if (setorDetailsModal) {
    setorDetailsModal.addEventListener('hidden.bs.modal', function() {
      setTimeout(fixModalScroll, 50);
    });
    
    setorDetailsModal.addEventListener('shown.bs.modal', function() {
      fixModalScroll();
    });
  }
  
  // Event listener para modal principal de analytics
  if (analyticsModal) {
    analyticsModal.addEventListener('hidden.bs.modal', function() {
      setTimeout(fixModalScroll, 50);
    });
    
    analyticsModal.addEventListener('shown.bs.modal', function() {
      fixModalScroll();
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    // Função para formatar valores em BRL
    function formatarBRL(valor) {
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL"
      }).format(valor);
    }

    // Formatar valores na página
    const elementosComValor = document.querySelectorAll("[data-valor]");
    elementosComValor.forEach(function(elemento) {
      const valorBruto = parseFloat(elemento.getAttribute("data-valor"));
      if (elemento.classList.contains('receita')) {
        elemento.textContent += formatarBRL(valorBruto);
      } else {
        elemento.textContent = formatarBRL(valorBruto);
      }
    });
  });

  // Função para gerar cores para gráficos
  function gerarCores(quantidade) {
    const cores = [
      '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1',
      '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#17a2b8',
      '#f8f9fa', '#e9ecef', '#dee2e6', '#ced4da', '#adb5bd'
    ];
    
    if (quantidade <= cores.length) {
      return cores.slice(0, quantidade);
    }
    
    // Gerar cores adicionais se necessário
    const coresExtras = [];
    for (let i = cores.length; i < quantidade; i++) {
      const hue = (i * 137.508) % 360; // Golden angle
      coresExtras.push(`hsl(${hue}, 70%, 50%)`);
    }
    
    return [...cores, ...coresExtras];
  }

  // Função para criar gráfico de pizza
  function criarGraficoPizza(containerId, titulo, dados, labelKey, valueKey) {
    const canvas = document.createElement('canvas');
    canvas.id = `chart-${containerId}`;
    
    const wrapper = document.createElement('div');
    wrapper.className = 'chart-wrapper';
    wrapper.innerHTML = `
      <div class="chart-title">${titulo}</div>
      <div class="chart-canvas"></div>
    `;
    wrapper.querySelector('.chart-canvas').appendChild(canvas);
    
    const cores = gerarCores(dados.length);
    
    const chart = new Chart(canvas, {
      type: 'pie',
      data: {
        labels: dados.map(item => item[labelKey]),
        datasets: [{
          data: dados.map(item => item[valueKey]),
          backgroundColor: cores,
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${formatarBRL(value)} (${percentage}%)`;
              }
            }
          }
        },
        // Configurações para impressão
        animation: {
          duration: 0 // Desabilitar animação para impressão
        }
      }
    });
    
    analyticsCharts[containerId] = chart;
    return wrapper;
  }

  // Função para criar gráfico de barras
  function criarGraficoBarras(containerId, titulo, dados, labelKey, valueKey) {
    const canvas = document.createElement('canvas');
    canvas.id = `chart-${containerId}`;
    
    const wrapper = document.createElement('div');
    wrapper.className = 'chart-wrapper';
    wrapper.innerHTML = `
      <div class="chart-title">${titulo}</div>
      <div class="chart-canvas"></div>
    `;
    wrapper.querySelector('.chart-canvas').appendChild(canvas);
    
    const cores = gerarCores(dados.length);
    
    const chart = new Chart(canvas, {
      type: 'bar',
      data: {
        labels: dados.map(item => item[labelKey]),
        datasets: [{
          label: 'Receita (R$)',
          data: dados.map(item => item[valueKey]),
          backgroundColor: cores,
          borderColor: cores.map(cor => cor.replace('0.7', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return formatarBRL(value);
              }
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Receita: ${formatarBRL(context.parsed.y)}`;
              }
            }
          }
        },
        // Configurações para impressão
        animation: {
          duration: 0
        }
      }
    });
    
    analyticsCharts[containerId] = chart;
    return wrapper;
  }

  // Função para limpar gráficos existentes
  function limparGraficos() {
    Object.values(analyticsCharts).forEach(chart => {
      chart.destroy();
    });
    analyticsCharts = {};
  }

  // Função para criar gráficos baseados nos dados
  function criarGraficos(data) {
    const container = document.getElementById('chartsContainer');
    container.innerHTML = '';
    
    limparGraficos();
    
    // Gráfico de pizza por tipo de usuário
    if (data.por_tipo_usuario && data.por_tipo_usuario.length > 0) {
      const graficoUsuarios = criarGraficoPizza(
        'usuarios',
        'Distribuição de Receita por Tipo de Usuário',
        data.por_tipo_usuario,
        'tipo_usuario',
        'total_receita'
      );
      container.appendChild(graficoUsuarios);
    }
    
    // Gráfico de pizza por setor
    if (data.por_setor && data.por_setor.length > 0) {
      const graficoSetores = criarGraficoPizza(
        'setores',
        'Distribuição de Receita por Setor',
        data.por_setor,
        'setor',
        'total_receita'
      );
      container.appendChild(graficoSetores);
    }
    
    // Gráfico de barras por tipo de refeição (só no TOTAL_GERAL)
    if (currentAnalyticsType === 'TOTAL_GERAL' && data.por_tipo_refeicao && data.por_tipo_refeicao.length > 0) {
      const graficoTipos = criarGraficoBarras(
        'tipos-refeicao',
        'Receita por Tipo de Refeição',
        data.por_tipo_refeicao,
        'tipo_refeicao',
        'total_receita'
      );
      graficoTipos.classList.add('full-width-chart');
      container.appendChild(graficoTipos);
    }
  }

  // Função para abrir modal de analytics
  function abrirAnalytics(tipoRefeicao) {
    currentAnalyticsType = tipoRefeicao;
    
    // Atualizar título
    if (tipoRefeicao === 'TOTAL_GERAL') {
      document.getElementById('analyticsTypeTitle').textContent = 'Visão Geral Completa';
    } else {
      document.getElementById('analyticsTypeTitle').textContent = tipoRefeicao;
    }
    
    // Feedback visual no card
    const card = document.querySelector(`[data-tipo="${tipoRefeicao}"]`);
    if (card) {
      card.style.opacity = '0.7';
      card.style.transform = 'scale(0.98)';
    }
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
    modal.show();
    
    // Restaurar visual do card
    setTimeout(() => {
      if (card) {
        card.style.opacity = '';
        card.style.transform = '';
      }
    }, 300);
    
    // Carregar dados
    carregarDadosAnalytics(tipoRefeicao);
  }

  function renderizarAnalyticsByUserType(dados) {
  const container = document.getElementById('analyticsByUserType');
  
  if (!dados || dados.length === 0) {
    container.innerHTML = '<div class="no-data-message"><p>Nenhum dado encontrado para tipos de usuário.</p></div>';
    return;
  }
  
  let html = '';
  dados.forEach(item => {
    const percentual = (item.total_receita / dados.reduce((sum, d) => sum + d.total_receita, 0)) * 100;
    
    html += `
      <div class="metric-card user-type-card" data-user-type="${item.tipo_usuario}" style="cursor: pointer; transition: all 0.3s ease;" 
           onclick="abrirDetalhesUsuarios('${item.tipo_usuario}')" 
           title="Clique para ver detalhes individuais dos usuários">
        <div class="metric-title">
          ${item.tipo_usuario}
          <small class="text-muted float-end">
            <i class="fas fa-users"></i> Clique para detalhes
          </small>
        </div>
        <div class="metric-value">
          <div>
            <span class="metric-number">${item.total_pedidos} pedidos</span>
            <span class="text-muted">• ${item.total_unidades} unidades</span>
          </div>
          <div class="metric-money">${formatarBRL(item.total_receita)}</div>
        </div>
        <div class="progress-container">
          <div class="progress">
            <div class="progress-bar bg-primary" style="width: ${percentual}%"></div>
          </div>
          <small class="text-muted">${percentual.toFixed(1)}% do total</small>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  
  // Adicionar efeito hover
  container.querySelectorAll('.user-type-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-3px)';
      this.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '';
    });
  });
}

  // Função para carregar dados de analytics
  function carregarDadosAnalytics(tipoRefeicao) {
    // Mostrar loading
    document.getElementById('analyticsLoading').classList.remove('d-none');
    document.getElementById('analyticsContent').classList.add('d-none');
    document.getElementById('analyticsError').classList.add('d-none');
    
    // Verificar cache (válido por 5 minutos)
    const cacheKey = `${tipoRefeicao}_${window.location.search}`;
    const cacheData = analyticsCache[cacheKey];
    if (cacheData && (Date.now() - cacheData.timestamp) < 300000) {
      setTimeout(() => {
        processarDadosAnalytics(cacheData.data);
      }, 500);
      return;
    }
    
    // Construir URL com filtros
    const params = new URLSearchParams();
    const filtros = ['nome', 'nome_prato', 'tipo_usuario', 'setor', 'data_inicio', 'data_fim', 'tipo_refeicao'];
    filtros.forEach(filtro => {
      const elemento = document.querySelector(`[name="${filtro}"]`);
      if (elemento && elemento.value) {
        params.append(filtro, elemento.value);
      }
    });
    
    // Escolher URL baseado no tipo
    let url;
    if (tipoRefeicao === 'TOTAL_GERAL') {
      url = `{{=URL('default', 'api_analytics_geral')}}?${params.toString()}`;
    } else {
      params.append('tipo_refeicao_analytics', tipoRefeicao);
      url = `{{=URL('default', 'api_analytics_tipo_refeicao')}}?${params.toString()}`;
    }
    
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          // Salvar no cache
          analyticsCache[cacheKey] = {
            data: data,
            timestamp: Date.now()
          };
          processarDadosAnalytics(data);
        } else {
          mostrarErroAnalytics(data.message || 'Erro desconhecido');
        }
      })
      .catch(error => {
        console.error('Erro ao carregar analytics:', error);
        mostrarErroAnalytics(`Erro de conexão: ${error.message}`);
      });
  }

  // Função para processar e exibir dados de analytics
  function processarDadosAnalytics(data) {
    // Esconder loading
    document.getElementById('analyticsLoading').classList.add('d-none');
    document.getElementById('analyticsContent').classList.remove('d-none');
    
    // Atualizar subtitle
    const filtrosAtivos = [];
    const filtros = {
      'nome': 'Nome do usuário',
      'nome_prato': 'Nome do prato',
      'tipo_usuario': 'Tipo de usuário',
      'setor': 'Setor',
      'data_inicio': 'Data início',
      'data_fim': 'Data fim'
    };
    
    Object.keys(filtros).forEach(filtro => {
      const elemento = document.querySelector(`[name="${filtro}"]`);
      if (elemento && elemento.value) {
        let valor = elemento.value;
        if (filtro === 'setor') {
          const option = elemento.options[elemento.selectedIndex];
          valor = option ? option.text : valor;
        }
        filtrosAtivos.push(`${filtros[filtro]}: ${valor}`);
      }
    });
    
    const subtitleText = filtrosAtivos.length > 0 
      ? `Filtros aplicados: ${filtrosAtivos.join(' | ')}`
      : currentAnalyticsType === 'TOTAL_GERAL' 
        ? 'Análise completa com gráficos visuais de todos os tipos' 
        : 'Análise completa com gráficos visuais por tipo de usuário e setor';
    
    document.getElementById('analyticsSubtitle').textContent = subtitleText;
    
    // Atualizar resumo geral
    const resumo = data.resumo_geral;
    document.getElementById('summaryTotalPedidos').textContent = resumo.total_pedidos;
    document.getElementById('summaryTotalUnidades').textContent = resumo.total_unidades;
    document.getElementById('summaryTotalReceita').textContent = formatarBRL(resumo.total_receita);
    document.getElementById('summaryMediaPedido').textContent = formatarBRL(resumo.media_por_pedido);
    
    // Criar gráficos
    criarGraficos(data);
    
    // Se for TOTAL_GERAL, mostrar analytics por tipo de refeição
    const sectionTipoRefeicao = document.getElementById('sectionByTipoRefeicao');
    if (currentAnalyticsType === 'TOTAL_GERAL' && data.por_tipo_refeicao) {
      sectionTipoRefeicao.style.display = 'block';
      renderizarAnalyticsByTipoRefeicao(data.por_tipo_refeicao);
    } else {
      sectionTipoRefeicao.style.display = 'none';
    }
    
    // Renderizar tabelas
    renderizarAnalyticsByUserType(data.por_tipo_usuario);
    renderizarAnalyticsBySetor(data.por_setor);
  }

function renderizarAnalyticsByTipoRefeicao(dados) {
  const container = document.getElementById('analyticsByTipoRefeicao');
  
  if (!dados || dados.length === 0) {
    container.innerHTML = '<div class="no-data-message"><p>Nenhum dado encontrado para tipos de refeição.</p></div>';
    return;
  }
  
  let html = '';
  dados.forEach(item => {
    const percentual = (item.total_receita / dados.reduce((sum, d) => sum + d.total_receita, 0)) * 100;
    
    html += `
      <div class="metric-card tipo-refeicao-card" data-tipo-refeicao="${item.tipo_refeicao}" style="cursor: pointer; transition: all 0.3s ease;" 
           onclick="abrirDetalhesTipoRefeicao('${item.tipo_refeicao}')" 
           title="Clique para ver detalhes individuais dos usuários que consumiram ${item.tipo_refeicao}">
        <div class="metric-title">
          ${item.tipo_refeicao || 'Sem tipo definido'}
          <small class="text-muted float-end">
            <i class="fas fa-utensils"></i> Clique para detalhes
          </small>
        </div>
        <div class="metric-value">
          <div>
            <span class="metric-number">${item.total_pedidos} pedidos</span>
            <span class="text-muted">• ${item.total_unidades} unidades</span>
          </div>
          <div class="metric-money">${formatarBRL(item.total_receita)}</div>
        </div>
        <div class="progress-container">
          <div class="progress">
            <div class="progress-bar bg-warning" style="width: ${percentual}%"></div>
          </div>
          <small class="text-muted">${percentual.toFixed(1)}% do total</small>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  
  // Adicionar efeito hover
  container.querySelectorAll('.tipo-refeicao-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-3px)';
      this.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '';
    });
  });
}
  
  function renderizarAnalyticsBySetor(dados) {
  const container = document.getElementById('analyticsBySetor');
  
  if (!dados || dados.length === 0) {
    container.innerHTML = '<div class="no-data-message"><p>Nenhum dado encontrado para setores.</p></div>';
    return;
  }
  
  let html = '';
  dados.forEach(item => {
    const percentual = (item.total_receita / dados.reduce((sum, d) => sum + d.total_receita, 0)) * 100;
    
    html += `
      <div class="metric-card setor-card" data-setor="${item.setor}" style="cursor: pointer; transition: all 0.3s ease;" 
           onclick="abrirDetalhesSetor('${item.setor}')" 
           title="Clique para ver detalhes individuais dos usuários do setor">
        <div class="metric-title">
          ${item.setor || 'Sem setor definido'}
          <small class="text-muted float-end">
            <i class="fas fa-building"></i> Clique para detalhes
          </small>
        </div>
        <div class="metric-value">
          <div>
            <span class="metric-number">${item.total_pedidos} pedidos</span>
            <span class="text-muted">• ${item.total_unidades} unidades</span>
          </div>
          <div class="metric-money">${formatarBRL(item.total_receita)}</div>
        </div>
        <div class="progress-container">
          <div class="progress">
            <div class="progress-bar bg-success" style="width: ${percentual}%"></div>
          </div>
          <small class="text-muted">${percentual.toFixed(1)}% do total</small>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  
  // Adicionar efeito hover
  container.querySelectorAll('.setor-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-3px)';
      this.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '';
    });
  });
}

  // Função para mostrar erro
  function mostrarErroAnalytics(mensagem) {
    document.getElementById('analyticsLoading').classList.add('d-none');
    document.getElementById('analyticsContent').classList.add('d-none');
    document.getElementById('analyticsError').classList.remove('d-none');
  }

  // Função para recarregar analytics
  function recarregarAnalytics() {
    if (currentAnalyticsType) {
      const cacheKey = `${currentAnalyticsType}_${window.location.search}`;
      delete analyticsCache[cacheKey];
      carregarDadosAnalytics(currentAnalyticsType);
    }
  }

  // Função para exportar analytics para CSV
  function exportarAnalytics() {
    if (!currentAnalyticsType) return;
    
    const cacheKey = `${currentAnalyticsType}_${window.location.search}`;
    const cacheData = analyticsCache[cacheKey];
    if (!cacheData) {
      alert('Dados não carregados. Aguarde o carregamento dos analytics.');
      return;
    }
    
    const data = cacheData.data;
    let csvContent = "data:text/csv;charset=utf-8,";
    
    const tipoTitulo = currentAnalyticsType === 'TOTAL_GERAL' ? 'Visão Geral Completa' : currentAnalyticsType;
    csvContent += `Relatório Analytics - ${tipoTitulo}\n`;
    csvContent += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n\n`;
    
    // Resumo geral
    csvContent += "RESUMO GERAL\n";
    csvContent += "Métrica,Valor\n";
    csvContent += `Total de Pedidos,${data.resumo_geral.total_pedidos}\n`;
    csvContent += `Total de Unidades,${data.resumo_geral.total_unidades}\n`;
    csvContent += `Receita Total,${formatarBRL(data.resumo_geral.total_receita)}\n`;
    csvContent += `Média por Pedido,${formatarBRL(data.resumo_geral.media_por_pedido)}\n\n`;
    
    // Por tipo de refeição (se for TOTAL_GERAL)
    if (data.por_tipo_refeicao) {
      csvContent += "CONSUMO POR TIPO DE REFEIÇÃO\n";
      csvContent += "Tipo de Refeição,Pedidos,Unidades,Receita\n";
      data.por_tipo_refeicao.forEach(item => {
        csvContent += `${item.tipo_refeicao},${item.total_pedidos},${item.total_unidades},${formatarBRL(item.total_receita)}\n`;
      });
      csvContent += "\n";
    }
    
    // Por tipo de usuário
    csvContent += "CONSUMO POR TIPO DE USUÁRIO\n";
    csvContent += "Tipo de Usuário,Pedidos,Unidades,Receita\n";
    data.por_tipo_usuario.forEach(item => {
      csvContent += `${item.tipo_usuario},${item.total_pedidos},${item.total_unidades},${formatarBRL(item.total_receita)}\n`;
    });
    csvContent += "\n";
    
    // Por setor
    csvContent += "CONSUMO POR SETOR\n";
    csvContent += "Setor,Pedidos,Unidades,Receita\n";
    data.por_setor.forEach(item => {
      csvContent += `${item.setor},${item.total_pedidos},${item.total_unidades},${formatarBRL(item.total_receita)}\n`;
    });
    
    // Download
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    const fileName = currentAnalyticsType === 'TOTAL_GERAL' ? 'GERAL' : currentAnalyticsType;
    link.setAttribute("download", `analytics_${fileName}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Função para imprimir analytics COM GRÁFICOS
  function imprimirAnalytics() {
    if (!currentAnalyticsType) return;
    
    const cacheKey = `${currentAnalyticsType}_${window.location.search}`;
    const cacheData = analyticsCache[cacheKey];
    if (!cacheData) {
      alert('Dados não carregados. Aguarde o carregamento dos analytics.');
      return;
    }
    
    // Converter gráficos para imagens
    const graficosImagens = {};
    Object.keys(analyticsCharts).forEach(key => {
      const chart = analyticsCharts[key];
      graficosImagens[key] = chart.toBase64Image('image/png', 1.0);
    });
    
    const data = cacheData.data;
    const tipoTitulo = currentAnalyticsType === 'TOTAL_GERAL' ? 'Visão Geral Completa' : currentAnalyticsType;
    
    // Criar janela de impressão
    const printWindow = window.open('', '_blank');
    
    let tipoRefeicaoSection = '';
    if (data.por_tipo_refeicao) {
      tipoRefeicaoSection = `
        <div class="section">
          <h3>Consumo por Tipo de Refeição</h3>
          <table>
            <thead>
              <tr>
                <th>Tipo de Refeição</th>
                <th>Pedidos</th>
                <th>Unidades</th>
                <th>Receita</th>
              </tr>
            </thead>
            <tbody>
              ${data.por_tipo_refeicao.map(item => `
                <tr>
                  <td>${item.tipo_refeicao}</td>
                  <td>${item.total_pedidos}</td>
                  <td>${item.total_unidades}</td>
                  <td>${formatarBRL(item.total_receita)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Seção de gráficos
    let graficosSection = '';
    if (Object.keys(graficosImagens).length > 0) {
      graficosSection = `
        <div class="section">
          <h3>Análise Visual</h3>
          <div class="charts-print">
            ${Object.keys(graficosImagens).map(key => `
              <div class="chart-print">
                <img src="${graficosImagens[key]}" style="max-width: 100%; height: auto; margin-bottom: 20px;" />
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Analytics ${tipoTitulo}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 15px; }
          .section { margin-bottom: 30px; page-break-inside: avoid; }
          .section h3 { color: #007bff; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f8f9fa; font-weight: bold; }
          .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; }
          .summary-item { text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
          .summary-value { font-size: 1.2em; font-weight: bold; color: #007bff; }
          .charts-print { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
          .chart-print { text-align: center; page-break-inside: avoid; }
          @media print { 
            body { margin: 0; } 
            .section { page-break-inside: avoid; }
            .charts-print { grid-template-columns: 1fr; }
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>Relatório Analytics - ${tipoTitulo}</h1>
          <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
        </div>
        
        <div class="section">
          <h3>Resumo Geral</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-value">${data.resumo_geral.total_pedidos}</div>
              <div>Total de Pedidos</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${data.resumo_geral.total_unidades}</div>
              <div>Total de Unidades</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${formatarBRL(data.resumo_geral.total_receita)}</div>
              <div>Receita Total</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${formatarBRL(data.resumo_geral.media_por_pedido)}</div>
              <div>Média por Pedido</div>
            </div>
          </div>
        </div>
        
        ${graficosSection}
        
        ${tipoRefeicaoSection}
        
        <div class="section">
          <h3>Consumo por Tipo de Usuário</h3>
          <table>
            <thead>
              <tr>
                <th>Tipo de Usuário</th>
                <th>Pedidos</th>
                <th>Unidades</th>
                <th>Receita</th>
              </tr>
            </thead>
            <tbody>
              ${data.por_tipo_usuario.map(item => `
                <tr>
                  <td>${item.tipo_usuario}</td>
                  <td>${item.total_pedidos}</td>
                  <td>${item.total_unidades}</td>
                  <td>${formatarBRL(item.total_receita)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <div class="section">
          <h3>Consumo por Setor</h3>
          <table>
            <thead>
              <tr>
                <th>Setor</th>
                <th>Pedidos</th>
                <th>Unidades</th>
                <th>Receita</th>
              </tr>
            </thead>
            <tbody>
              ${data.por_setor.map(item => `
                <tr>
                  <td>${item.setor}</td>
                  <td>${item.total_pedidos}</td>
                  <td>${item.total_unidades}</td>
                  <td>${formatarBRL(item.total_receita)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </body>
      </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    
    // Aguardar carregamento antes de imprimir
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 500);
  }

  // Função auxiliar para formatação
  function formatarBRL(valor) {
    return new Intl.NumberFormat("pt-BR", {
      style: "currency",
      currency: "BRL"
    }).format(valor);
  }

  // Event listeners para pedidos
  $(document).ready(function () {
    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Modal de detalhes do pedido
    $(".pedido-row").click(function () {
      var prato = $(this).data("prato");
      var quantidade = $(this).data("quantidade");
      var preco = parseFloat($(this).data("preco"));
      var descricao = $(this).data("descricao") || "Nenhuma descrição fornecida.";

      $("#modalPratoNome").text(prato);
      $("#modalQuantidade").text(quantidade);
      $("#modalPreco").text(preco.toFixed(2));
      $("#modalDescricao").text(descricao);
      
      const modal = new bootstrap.Modal(document.getElementById('pedidoModal'));
      modal.show();
    });

    // Filtro pelo tipo de refeição
    $("#tipo_refeicao").change(function() {
      var selectedTipo = $(this).val();

      $(".pedido-row").each(function() {
        var tipoRefeicao = $(this).data("tipo-refeicao");

        if (selectedTipo === "" || tipoRefeicao === selectedTipo) {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
    });

    // Animação nos cards de resumo
    $('.resumo-tipo').hover(
      function() {
        $(this).addClass('shadow-lg');
      },
      function() {
        $(this).removeClass('shadow-lg');
      }
    );
  });

  // Função para abrir modal de detalhes por usuários
function abrirDetalhesUsuarios(tipoUsuario) {
  // Atualizar título
  document.getElementById('userTypeTitle').textContent = tipoUsuario;
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
  modal.show();
  
  // Carregar dados
  carregarDetalhesUsuarios(tipoUsuario);
}

// Função para carregar detalhes dos usuários
function carregarDetalhesUsuarios(tipoUsuario) {
  // Mostrar loading
  document.getElementById('userDetailsLoading').classList.remove('d-none');
  document.getElementById('userDetailsContent').classList.add('d-none');
  document.getElementById('userDetailsError').classList.add('d-none');
  
  // Construir URL com todos os filtros atuais
  const params = new URLSearchParams();
  const filtros = ['nome', 'nome_prato', 'setor', 'data_inicio', 'data_fim', 'tipo_refeicao'];
  filtros.forEach(filtro => {
    const elemento = document.querySelector(`[name="${filtro}"]`);
    if (elemento && elemento.value) {
      params.append(filtro, elemento.value);
    }
  });
  
  // Adicionar tipo de usuário e tipo de refeição atual
  params.append('tipo_usuario_detalhes', tipoUsuario);
  if (currentAnalyticsType && currentAnalyticsType !== 'TOTAL_GERAL') {
    params.append('tipo_refeicao_analytics', currentAnalyticsType);
  }
  
  const url = `{{=URL('default', 'api_detalhes_usuarios_por_tipo')}}?${params.toString()}`;
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        renderizarDetalhesUsuarios(data);
      } else {
        mostrarErroDetalhesUsuarios();
      }
    })
    .catch(error => {
      console.error('Erro ao carregar detalhes dos usuários:', error);
      mostrarErroDetalhesUsuarios();
    });
}

// Função para renderizar tabela de detalhes dos usuários
function renderizarDetalhesUsuarios(data) {
  // Esconder loading
  document.getElementById('userDetailsLoading').classList.add('d-none');
  document.getElementById('userDetailsContent').classList.remove('d-none');
  
  // Atualizar resumo
  document.getElementById('totalUsers').textContent = data.resumo.total_usuarios;
  document.getElementById('totalRevenue').textContent = formatarBRL(data.resumo.receita_total);
  
  // Renderizar tabela
  const tbody = document.getElementById('userDetailsTable');
  tbody.innerHTML = '';
  
  data.usuarios.forEach(usuario => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="fw-bold">${usuario.nome_usuario}</td>
      <td>${usuario.setor}</td>
      <td><span class="badge bg-info">${usuario.total_pedidos}</span></td>
      <td class="fw-bold text-success">${formatarBRL(usuario.total_gasto)}</td>
      <td>${formatarBRL(usuario.media_por_pedido)}</td>
    `;
    tbody.appendChild(row);
  });
  
  // Armazenar dados para exportação
  window.currentUserDetails = data;
}

// Função para mostrar erro
function mostrarErroDetalhesUsuarios() {
  document.getElementById('userDetailsLoading').classList.add('d-none');
  document.getElementById('userDetailsContent').classList.add('d-none');
  document.getElementById('userDetailsError').classList.remove('d-none');
}

// Função para exportar detalhes dos usuários
function exportarDetalhesUsuarios() {
  if (!window.currentUserDetails) {
    alert('Nenhum dado para exportar');
    return;
  }
  
  const data = window.currentUserDetails;
  let csvContent = "data:text/csv;charset=utf-8,";
  
  csvContent += `Detalhes dos Usuários - ${data.tipo_usuario}\n`;
  csvContent += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n\n`;
  
  csvContent += "Nome do Usuário,Setor,Total de Pedidos,Total Gasto,Média por Pedido\n";
  
  data.usuarios.forEach(usuario => {
    csvContent += `${usuario.nome_usuario},${usuario.setor},${usuario.total_pedidos},${formatarBRL(usuario.total_gasto)},${formatarBRL(usuario.media_por_pedido)}\n`;
  });
  
  // Download
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `detalhes_usuarios_${data.tipo_usuario}_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Função para abrir modal de detalhes por setor
function abrirDetalhesSetor(setor) {
  // Atualizar título
  document.getElementById('setorTitle').textContent = setor;
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('setorDetailsModal'));
  modal.show();
  
  // Carregar dados
  carregarDetalhesSetor(setor);
}

// Função para carregar detalhes do setor
function carregarDetalhesSetor(setor) {
  // Mostrar loading
  document.getElementById('setorDetailsLoading').classList.remove('d-none');
  document.getElementById('setorDetailsContent').classList.add('d-none');
  document.getElementById('setorDetailsError').classList.add('d-none');
  
  // Construir URL com todos os filtros atuais
  const params = new URLSearchParams();
  const filtros = ['nome', 'nome_prato', 'tipo_usuario', 'data_inicio', 'data_fim', 'tipo_refeicao'];
  filtros.forEach(filtro => {
    const elemento = document.querySelector(`[name="${filtro}"]`);
    if (elemento && elemento.value) {
      params.append(filtro, elemento.value);
    }
  });
  
  // Adicionar setor e tipo de refeição atual
  params.append('setor_detalhes', setor);
  if (currentAnalyticsType && currentAnalyticsType !== 'TOTAL_GERAL') {
    params.append('tipo_refeicao_analytics', currentAnalyticsType);
  }
  
  const url = `{{=URL('default', 'api_detalhes_usuarios_por_setor')}}?${params.toString()}`;
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        renderizarDetalhesSetor(data);
      } else {
        mostrarErroDetalhesSetor();
      }
    })
    .catch(error => {
      console.error('Erro ao carregar detalhes do setor:', error);
      mostrarErroDetalhesSetor();
    });
}

// Função para renderizar tabela de detalhes do setor
function renderizarDetalhesSetor(data) {
  // Esconder loading
  document.getElementById('setorDetailsLoading').classList.add('d-none');
  document.getElementById('setorDetailsContent').classList.remove('d-none');
  
  // Atualizar resumo
  document.getElementById('totalUsersSetor').textContent = data.resumo.total_usuarios;
  document.getElementById('totalRevenueSetor').textContent = formatarBRL(data.resumo.receita_total);
  
  // Renderizar tabela
  const tbody = document.getElementById('setorDetailsTable');
  tbody.innerHTML = '';
  
  data.usuarios.forEach(usuario => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="fw-bold">${usuario.nome_usuario}</td>
      <td><span class="badge bg-secondary">${usuario.tipo_usuario}</span></td>
      <td><span class="badge bg-info">${usuario.total_pedidos}</span></td>
      <td class="fw-bold text-success">${formatarBRL(usuario.total_gasto)}</td>
      <td>${formatarBRL(usuario.media_por_pedido)}</td>
    `;
    tbody.appendChild(row);
  });
  
  // Armazenar dados para exportação
  window.currentSetorDetails = data;
}

// Função para mostrar erro
function mostrarErroDetalhesSetor() {
  document.getElementById('setorDetailsLoading').classList.add('d-none');
  document.getElementById('setorDetailsContent').classList.add('d-none');
  document.getElementById('setorDetailsError').classList.remove('d-none');
}

// Função para exportar detalhes do setor
function exportarDetalhesSetor() {
  if (!window.currentSetorDetails) {
    alert('Nenhum dado para exportar');
    return;
  }
  
  const data = window.currentSetorDetails;
  let csvContent = "data:text/csv;charset=utf-8,";
  
  csvContent += `Detalhes do Setor - ${data.setor}\n`;
  csvContent += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n\n`;
  
  csvContent += "Nome do Usuário,Tipo de Usuário,Total de Pedidos,Total Gasto,Média por Pedido\n";
  
  data.usuarios.forEach(usuario => {
    csvContent += `${usuario.nome_usuario},${usuario.tipo_usuario},${usuario.total_pedidos},${formatarBRL(usuario.total_gasto)},${formatarBRL(usuario.media_por_pedido)}\n`;
  });
  
  // Download
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `detalhes_setor_${data.setor}_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Função para abrir modal de detalhes por tipo de refeição
function abrirDetalhesTipoRefeicao(tipoRefeicao) {
  // Atualizar título
  document.getElementById('tipoRefeicaoTitle').textContent = tipoRefeicao;
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('tipoRefeicaoDetailsModal'));
  modal.show();
  
  // Carregar dados
  carregarDetalhesTipoRefeicao(tipoRefeicao);
}

// Função para carregar detalhes do tipo de refeição
function carregarDetalhesTipoRefeicao(tipoRefeicao) {
  // Mostrar loading
  document.getElementById('tipoRefeicaoDetailsLoading').classList.remove('d-none');
  document.getElementById('tipoRefeicaoDetailsContent').classList.add('d-none');
  document.getElementById('tipoRefeicaoDetailsError').classList.add('d-none');
  
  // Construir URL com todos os filtros atuais
  const params = new URLSearchParams();
  const filtros = ['nome', 'nome_prato', 'tipo_usuario', 'setor', 'data_inicio', 'data_fim', 'tipo_refeicao'];
  filtros.forEach(filtro => {
    const elemento = document.querySelector(`[name="${filtro}"]`);
    if (elemento && elemento.value) {
      params.append(filtro, elemento.value);
    }
  });
  
  // Adicionar tipo de refeição
  params.append('tipo_refeicao_detalhes', tipoRefeicao);
  
  const url = `{{=URL('default', 'api_detalhes_usuarios_por_tipo_refeicao')}}?${params.toString()}`;
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        renderizarDetalhesTipoRefeicao(data);
      } else {
        mostrarErroDetalhesTipoRefeicao();
      }
    })
    .catch(error => {
      console.error('Erro ao carregar detalhes do tipo de refeição:', error);
      mostrarErroDetalhesTipoRefeicao();
    });
}

// Função para renderizar tabela de detalhes do tipo de refeição
function renderizarDetalhesTipoRefeicao(data) {
  // Esconder loading
  document.getElementById('tipoRefeicaoDetailsLoading').classList.add('d-none');
  document.getElementById('tipoRefeicaoDetailsContent').classList.remove('d-none');
  
  // Atualizar resumo
  document.getElementById('totalUsersTipoRefeicao').textContent = data.resumo.total_usuarios;
  document.getElementById('totalRevenueTipoRefeicao').textContent = formatarBRL(data.resumo.receita_total);
  
  // Renderizar tabela
  const tbody = document.getElementById('tipoRefeicaoDetailsTable');
  tbody.innerHTML = '';
  
  data.usuarios.forEach(usuario => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="fw-bold">${usuario.nome_usuario}</td>
      <td><span class="badge bg-secondary">${usuario.tipo_usuario}</span></td>
      <td>${usuario.setor}</td>
      <td><span class="badge bg-info">${usuario.total_pedidos}</span></td>
      <td class="fw-bold text-success">${formatarBRL(usuario.total_gasto)}</td>
      <td>${formatarBRL(usuario.media_por_pedido)}</td>
    `;
    tbody.appendChild(row);
  });
  
  // Armazenar dados para exportação
  window.currentTipoRefeicaoDetails = data;
}

// Função para mostrar erro
function mostrarErroDetalhesTipoRefeicao() {
  document.getElementById('tipoRefeicaoDetailsLoading').classList.add('d-none');
  document.getElementById('tipoRefeicaoDetailsContent').classList.add('d-none');
  document.getElementById('tipoRefeicaoDetailsError').classList.remove('d-none');
}

// Função para exportar detalhes do tipo de refeição
function exportarDetalhesTipoRefeicao() {
  if (!window.currentTipoRefeicaoDetails) {
    alert('Nenhum dado para exportar');
    return;
  }
  
  const data = window.currentTipoRefeicaoDetails;
  let csvContent = "data:text/csv;charset=utf-8,";
  
  csvContent += `Detalhes do Tipo de Refeição - ${data.tipo_refeicao}\n`;
  csvContent += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n\n`;
  
  csvContent += "Nome do Usuário,Tipo de Usuário,Setor,Total de Pedidos,Total Gasto,Média por Pedido\n";
  
  data.usuarios.forEach(usuario => {
    csvContent += `${usuario.nome_usuario},${usuario.tipo_usuario},${usuario.setor},${usuario.total_pedidos},${formatarBRL(usuario.total_gasto)},${formatarBRL(usuario.media_por_pedido)}\n`;
  });
  
  // Download
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `detalhes_tipo_refeicao_${data.tipo_refeicao}_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>