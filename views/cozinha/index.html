{{extend 'layout.html'}}

<h2>Pedidos Pendentes</h2>
<div id="loading" style="display: none">Carregando...</div>
<div class="mb-3">
  <button id="imprimir" class="btn btn-primary">Imprimir PDF</button>
</div>
<div id="status-info" class="alert alert-info mb-3">
  Sistema iniciado. Aguardando pedidos...
</div>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Solicitante</th>
      <th>Setor</th>
      <th>Prato</th>
      <th>Foto</th>
      <th>Quantidade</th>
      <th>Quarto</th>
      <th>Observações</th>
      <th>Status</th>
      <th>Ações</th>
      <th>Cancelar</th>
    </tr>
  </thead>
  <tbody id="tabela-pedidos">
    <!-- Os dados serão preenchidos via Ajax -->
  </tbody>
</table>

<!-- Modal para ampliar a imagem -->
<div
  class="modal fade"
  id="imageModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="imageModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Visualizar Imagem</h5>
        <button
          type="button"
          class="close"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" class="img-fluid" src="" alt="Imagem Ampliada" />
      </div>
    </div>
  </div>
</div>

<!-- Audio element para notificações -->
<audio id="notificationSound" preload="auto">
  <source
    src="{{=URL('static', 'sounds/notification.mp3')}}"
    type="audio/mpeg"
  />
</audio>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let pedidosAtuais = [];
    let primeiroCarregamento = true;

    // Função para tocar som de notificação
    function tocarNotificacao() {
      const audio = document.getElementById("notificationSound");
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch((error) => {
          console.log("Erro ao tocar som:", error);
        });
      }
    }

    // Função para atualizar status na tela
    function atualizarStatusInfo(mensagem, tipo = "info") {
      const statusElement = document.getElementById("status-info");
      statusElement.className = `alert alert-${tipo} mb-3`;
      statusElement.textContent = mensagem;

      // Auto-hide após 5 segundos para mensagens de sucesso
      if (tipo === "success") {
        setTimeout(() => {
          statusElement.className = "alert alert-info mb-3";
          statusElement.textContent = "Buscando novos pedidos...";
        }, 5000);
      }
    }

    // Função para comparar pedidos e detectar novos
    function detectarNovosPedidos(novosPedidos) {
      if (primeiroCarregamento) {
        return [];
      }

      const idsAtuais = new Set(pedidosAtuais.map((p) => p.id));
      const novosPedidosDetectados = novosPedidos.filter(
        (p) => !idsAtuais.has(p.id)
      );

      console.log("IDs atuais:", Array.from(idsAtuais));
      console.log(
        "IDs dos novos pedidos:",
        novosPedidos.map((p) => p.id)
      );
      console.log(
        "Novos pedidos detectados:",
        novosPedidosDetectados.map((p) => p.id)
      );

      return novosPedidosDetectados;
    }

    // Função para imprimir pedidos
    function imprimirPedidos() {
      fetch("{{=URL('api_gerenciar_pedidos')}}")
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success" || data.pedidos) {
            const pedidos = data.pedidos;

            // Carregar o HTML do template de impressão
            fetch("{{=URL('static', 'print_template.html')}}")
              .then((response) => response.text())
              .then((templateHtml) => {
                const printIframe = document.createElement("iframe");
                printIframe.style.display = "none";
                document.body.appendChild(printIframe);

                const iframeDoc =
                  printIframe.contentDocument ||
                  printIframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(templateHtml);
                iframeDoc.close();

                // Preencher os dados no template
                const tabelaBody = iframeDoc.querySelector(
                  "#tabela-pedidos tbody"
                );
                if (tabelaBody) {
                  pedidos.forEach((pedido) => {
                    const linha = `
                      <tr>
                        <td>${pedido["Solicitante"]}</td>
                        <td>${pedido["Setor"] || "-"}</td>
                        <td>${pedido["Prato"]}</td>
                        <td>${pedido["Quantidade"]}</td>
                      </tr>
                    `;
                    tabelaBody.insertAdjacentHTML("beforeend", linha);
                  });
                }

                // Aguardar um pouco para garantir que o conteúdo foi carregado
                setTimeout(() => {
                  printIframe.contentWindow.print();
                  setTimeout(() => {
                    printIframe.remove();
                  }, 1000);
                }, 100);
              })
              .catch((error) => {
                console.error("Erro ao carregar template:", error);
                // Fallback: imprimir os dados atuais da tela
                imprimirPedidosAtual();
              });
          } else {
            const errorMessage =
              data.message || "Erro inesperado ao carregar pedidos.";
            alert("Erro ao carregar pedidos para impressão: " + errorMessage);
          }
        })
        .catch((error) => {
          console.error("Erro ao carregar pedidos:", error);
          // Fallback: imprimir os dados atuais da tela
          imprimirPedidosAtual();
        });
    }

    // Função fallback para imprimir pedidos atuais da tela
    function imprimirPedidosAtual() {
      const printWindow = window.open("", "_blank");
      const tabelaAtual = document.querySelector("#tabela-pedidos").innerHTML;

      const htmlImpressao = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Pedidos Pendentes</title>
          <style>
            body { font-family: Arial, sans-serif; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
            th { background-color: #f2f2f2; }
            h2 { text-align: center; }
            .no-print { display: none; }
          </style>
        </head>
        <body>
          <h2>Pedidos Pendentes - ${new Date().toLocaleString()}</h2>
          <table>
            <thead>
              <tr>
                <th>Solicitante</th>
                <th>Setor</th>
                <th>Prato</th>
                <th>Quantidade</th>
                <th>Quarto</th>
                <th>Observações</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${tabelaAtual
                .replace(/<img[^>]*>/g, "")
                .replace(/<button[^>]*>.*?<\/button>/g, "")}
            </tbody>
          </table>
        </body>
        </html>
      `;

      printWindow.document.write(htmlImpressao);
      printWindow.document.close();
      printWindow.print();
      printWindow.close();
    }

    // Função para carregar pedidos via Ajax
    function carregarPedidos(forcarAtualizacao = false) {
      if (forcarAtualizacao) {
        $("#loading").show();
      }

      $.ajax({
        url: "{{=URL('api_listar_pedidos')}}",
        method: "GET",
        success: function (response) {
          $("#loading").hide();
          if (response.status === "success") {
            const novosPedidos = response.pedidos;

            // Log para debug
            console.log(
              "Pedidos atuais:",
              pedidosAtuais.map((p) => p.id)
            );
            console.log(
              "Novos pedidos:",
              novosPedidos.map((p) => p.id)
            );

            // Detectar novos pedidos
            const pedidosNovos = detectarNovosPedidos(novosPedidos);
            console.log(
              "Pedidos detectados como novos:",
              pedidosNovos.map((p) => p.id)
            );

            // Verificar se há mudanças nos pedidos (novos, removidos ou alterados)
            const houveMudanca =
              pedidosNovos.length > 0 ||
              pedidosAtuais.length !== novosPedidos.length ||
              forcarAtualizacao ||
              primeiroCarregamento;

            console.log("Houve mudança:", houveMudanca);

            // Se há mudanças, atualizar a tela
            if (houveMudanca) {
              // Tocar som se há novos pedidos (não no primeiro carregamento)
              if (pedidosNovos.length > 0 && !primeiroCarregamento) {
                console.log("Tocando som de notificação");
                tocarNotificacao();
                atualizarStatusInfo(
                  `${pedidosNovos.length} novo(s) pedido(s) recebido(s)!`,
                  "success"
                );
              }

              console.log("Atualizando tabela");

              // Atualizar pedidos atuais
              pedidosAtuais = [...novosPedidos];

              // Atualizar tabela
              const tabelaBody = $("#tabela-pedidos");
              tabelaBody.empty();

              novosPedidos.forEach((pedido) => {
                const isNovo = pedidosNovos.some((p) => p.id === pedido.id);
                const row = `
                  <tr id="pedido_${pedido.id}" class="${
                  pedido.status === "Em Preparação" ? "preparacao" : ""
                }${isNovo ? " novo-pedido" : ""}">
                    <td>${pedido.solicitante}</td>
                    <td>${pedido.setor}</td>
                    <td>${pedido.prato}</td>
                    <td>
                      ${
                        pedido.foto
                          ? `<img src="${pedido.foto}" class="img-thumbnail small-image" alt="Foto do Prato" />`
                          : ""
                      }
                    </td>
                    <td>${pedido.quantidade}</td>
                    <td>${pedido.quarto}</td>
                    <td>${pedido.observacoes}</td>
                    <td class="status">${pedido.status}</td>
                    <td>
                      <button class="btn ${
                        pedido.status === "Pendente"
                          ? "btn-danger"
                          : "btn-warning"
                      } atualizar-status" data-id="${pedido.id}">
                        Confirmar
                      </button>
                    </td>
                    <td>
                      <button class="btn btn-danger cancelar-pedido" data-id="${
                        pedido.id
                      }">X</button>
                    </td>
                  </tr>
                `;
                tabelaBody.append(row);
              });

              associarEventos();

              // Remover destaque de novos pedidos após 5 segundos
              setTimeout(() => {
                $(".novo-pedido").removeClass("novo-pedido");
              }, 5000);

              if (primeiroCarregamento) {
                primeiroCarregamento = false;
                atualizarStatusInfo("Buscando novos pedidos...", "info");
              }
            }

            // Atualizar status se não há mudanças
            if (!houveMudanca) {
              const agora = new Date().toLocaleTimeString();
              console.log(`${agora}: Nenhuma mudança detectada`);
              atualizarStatusInfo("Sem novos pedidos por hora.", "info");
            }
          } else {
            atualizarStatusInfo(
              "Erro ao carregar pedidos: " + response.message,
              "danger"
            );
          }
        },
        error: function () {
          $("#loading").hide();
          atualizarStatusInfo("Erro ao conectar com o servidor", "danger");
        },
      });
    }

    // Associar eventos aos botões
    function associarEventos() {
      $(".atualizar-status")
        .off("click")
        .on("click", function () {
          const pedidoId = $(this).data("id");
          const row = $(`#pedido_${pedidoId}`);
          const button = $(this);
          button.prop("disabled", true).text("Atualizando...");

          $.post(
            "{{=URL('atualizar_status')}}",
            { pedido_id: pedidoId },
            function (response) {
              button.prop("disabled", false).text("Confirmar");
              if (response.status === "success") {
                row.find(".status").text(response.novo_status);
                if (response.novo_status === "Em Preparação") {
                  row.addClass("preparacao").removeClass("pendente");
                } else {
                  row.removeClass("preparacao").addClass("pendente");
                }

                // Atualizar pedidos atuais
                const index = pedidosAtuais.findIndex((p) => p.id == pedidoId);
                if (index !== -1) {
                  pedidosAtuais[index].status = response.novo_status;
                }
              } else {
                alert("Erro ao atualizar status: " + response.message);
              }
            }
          );
        });

      $(".cancelar-pedido")
        .off("click")
        .on("click", function () {
          const pedidoId = $(this).data("id");
          const row = $(`#pedido_${pedidoId}`);
          if (confirm("Tem certeza de que deseja cancelar este pedido?")) {
            $.post(
              "{{=URL('cancelar_pedido')}}",
              { pedido_id: pedidoId },
              function (response) {
                if (response.status === "success") {
                  row.remove();

                  // Remover do array de pedidos atuais
                  pedidosAtuais = pedidosAtuais.filter((p) => p.id != pedidoId);
                } else {
                  alert("Erro ao cancelar pedido: " + response.message);
                }
              }
            );
          }
        });

      $(".small-image")
        .off("click")
        .on("click", function () {
          const imgSrc = $(this).attr("src");
          $("#modalImage").attr("src", imgSrc);
          $("#imageModal").modal("show");
        });
    }

    // Função para permitir que o usuário habilite o áudio
    function habilitarAudio() {
      document.addEventListener(
        "click",
        function enableAudio() {
          const audio = document.getElementById("notificationSound");
          audio
            .play()
            .then(() => {
              audio.pause();
              audio.currentTime = 0;
            })
            .catch(() => {
              // Silenciar erros de autoplay
            });
          document.removeEventListener("click", enableAudio);
        },
        { once: true }
      );
    }

    // Inicialização
    $("#imprimir").on("click", imprimirPedidos);

    // Habilitar áudio no primeiro clique
    habilitarAudio();

    // Carregar pedidos inicialmente
    carregarPedidos(true);

    // Verificar novos pedidos a cada 10 segundos
    setInterval(() => carregarPedidos(false), 10000);

    // Permitir atualização manual
    $(document).on("keydown", function (e) {
      if (e.key === "F5" || (e.ctrlKey && e.key === "r")) {
        e.preventDefault();
        atualizarStatusInfo("Atualizando manualmente...", "warning");
        carregarPedidos(true);
      }
    });
  });
</script>

<style>
  .preparacao {
    background-color: orange !important;
  }

  .novo-pedido {
    background-color: #d4edda !important;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      background-color: #d4edda;
    }
    50% {
      background-color: #c3e6cb;
    }
    100% {
      background-color: #d4edda;
    }
  }

  .small-image {
    width: 100px;
    cursor: pointer;
  }

  th,
  td {
    text-align: center;
  }

  .linha-azul {
    color: #1750cc !important;
    font-weight: 800;
  }

  #loading {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 1rem;
    text-align: center;
  }

  #status-info {
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
